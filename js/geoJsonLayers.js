import{loadData,loadAndMergeData}from"./dataLoader.js";import{map}from"./common.js";import{showDetailDrawer,hideDetailDrawer}from"./detailDrawer.js";var eventHandle={};let showSuspendedRoutes=!0;const popup=new maplibregl.Popup({closeButton:!1,closeOnClick:!1});export async function addGeoJsonLayer(e){switch(e){case"geojson_port":addGeoJsonPortLayer(),addPortClickEvent("geojson_port");break;case"geojson_sea_route":addGeoJsonSeaRouteLayer(),addSeaRouteClickEvent("geojson_sea_route","geojson_sea_route_outline");break;case"geojson_international_sea_route":addGeoJsonInternationalSeaRouteLayer(),addSeaRouteClickEvent("geojson_international_sea_route","geojson_international_sea_route_outline");break;case"geojson_KR_sea_route":addGeoJsonSeaRouteKRLayer(),addSeaRouteClickEvent("geojson_KR_sea_route","geojson_KR_sea_route_outline");break;case"geojson_limited_sea_route":addGeoJsonLimitedSeaRouteLayer(),addSeaRouteClickEvent("geojson_limited_sea_route","geojson_limited_sea_route_outline");break;default:return void console.log("[Error] Layer not found : addGeoJsonLayer( "+e+" )")}}export async function addMarker(e,o){if(!map.hasImage(e)){const t=await map.loadImage(o);map.addImage(e,t.data)}}async function addGeoJsonPortLayer(){addMarker("anchor_marker","./img/anchor.png");var e=await loadData("./data/portData.geojson");map.addSource("geojson_port",{type:"geojson",data:e,attribution:"<a href='https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-C02-v3_2.html' target='_blank'>「国土数値情報（港湾データ）」</a>を加工して作成"}),map.addLayer({id:"geojson_port",type:"symbol",source:"geojson_port",layout:{"icon-image":"anchor_marker","icon-size":.3,"text-field":["get","Name"],"text-font":["NotoSansCJKjp-Regular"],"text-size":12,"text-offset":[0,.8],"text-anchor":"top"}})}async function addGeoJsonSeaRouteLayer(){var e=await loadAndMergeData("./data/seaRoute.geojson","./data/seaRouteDetails.json","routeId");map.addSource("geojson_sea_route",{type:"geojson",data:e}),map.addLayer({id:"geojson_sea_route_outline",type:"line",source:"geojson_sea_route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#FFFFFF","line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],3],.5],6,["+",["*",["coalesce",["get","freq"],3],1],4]],"line-opacity":.5}}),map.addLayer({id:"geojson_sea_route_solidline",type:"line",source:"geojson_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],null],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],3],.5],6,["*",["coalesce",["get","freq"],3],1]],"line-dasharray":[1,0]}}),map.addLayer({id:"geojson_sea_route_dashline",type:"line",source:"geojson_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],"season"],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],3],.5],6,["*",["coalesce",["get","freq"],3],1]],"line-dasharray":[1,2]}}),map.addLayer({id:"geojson_sea_route_thinline",type:"line",source:"geojson_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],"suspend"],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],1],.75],6,["*",["coalesce",["get","freq"],1],1]],"line-dasharray":[1,4]}}),map.addLayer({id:"geojson_sea_route_name",type:"symbol",source:"geojson_sea_route",layout:{"symbol-placement":"line","text-offset":[0,1],"text-field":["step",["zoom"],"",4,["get","businessName"],6,["format",["get","businessName"],{}," (",{},["get","routeName"],{},") ",{}]],"text-font":["NotoSansCJKjp-Regular"],"text-size":9},paint:{"text-color":["coalesce",["get","color"],"#000000"],"text-halo-color":"#FFFFFF","text-halo-width":2,"text-halo-blur":2}})}async function addGeoJsonInternationalSeaRouteLayer(){var e=await loadAndMergeData("./data/internationalSeaRoute.geojson","./data/internationalSeaRouteDetails.json","routeId");map.addSource("geojson_international_sea_route",{type:"geojson",data:e}),map.addLayer({id:"geojson_international_sea_route_outline",type:"line",source:"geojson_international_sea_route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#FFFFFF","line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],3],.5],6,["+",["*",["coalesce",["get","freq"],3],1],4]],"line-opacity":.5}}),map.addLayer({id:"geojson_international_sea_route_solidline",type:"line",source:"geojson_international_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],null],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],1],.75],6,["*",["coalesce",["get","freq"],1],1]],"line-dasharray":[1,0]}}),map.addLayer({id:"geojson_international_sea_route_dashline",type:"line",source:"geojson_international_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],"season"],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],1],.75],6,["*",["coalesce",["get","freq"],1],1]],"line-dasharray":[1,2]}}),map.addLayer({id:"geojson_international_sea_route_thinline",type:"line",source:"geojson_international_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],"suspend"],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],1],.75],6,["*",["coalesce",["get","freq"],1],1]],"line-dasharray":[1,4]}}),map.addLayer({id:"geojson_international_sea_route_name",type:"symbol",source:"geojson_international_sea_route",layout:{"symbol-placement":"line","text-offset":[0,1],"text-field":["step",["zoom"],"",4,["get","businessName"],6,["format",["get","businessName"],{}," (",{},["get","routeName"],{},") ",{}]],"text-font":["NotoSansCJKjp-Regular"],"text-size":9},paint:{"text-color":["coalesce",["get","color"],"#000000"],"text-halo-color":"#FFFFFF","text-halo-width":2,"text-halo-blur":2}})}async function addGeoJsonSeaRouteKRLayer(){var e=await loadAndMergeData("./data/seaRouteKR.geojson","./data/seaRouteKRDetails.json","routeId");map.addSource("geojson_KR_sea_route",{type:"geojson",data:e}),map.addLayer({id:"geojson_KR_sea_route_outline",type:"line",source:"geojson_KR_sea_route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#FFFFFF","line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],3],.5],6,["+",["*",["coalesce",["get","freq"],3],1],4]],"line-opacity":.5}}),map.addLayer({id:"geojson_KR_sea_route_solidline",type:"line",source:"geojson_KR_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],null],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],1],.75],6,["*",["coalesce",["get","freq"],1],1]],"line-dasharray":[1,0]}}),map.addLayer({id:"geojson_KR_sea_route_dashline",type:"line",source:"geojson_KR_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],"season"],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],1],.75],6,["*",["coalesce",["get","freq"],1],1]],"line-dasharray":[1,2]}}),map.addLayer({id:"geojson_KR_sea_route_thinline",type:"line",source:"geojson_KR_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],"suspend"],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],1],.75],6,["*",["coalesce",["get","freq"],1],1]],"line-dasharray":[1,4]}}),map.addLayer({id:"geojson_KR_sea_route_name",type:"symbol",source:"geojson_KR_sea_route",layout:{"symbol-placement":"line","text-offset":[0,1],"text-field":["step",["zoom"],"",4,["get","businessName"],6,["format",["get","businessName"],{}," (",{},["get","routeName"],{},") ",{}]],"text-font":["NotoSansCJKjp-Regular"],"text-size":9},paint:{"text-color":["coalesce",["get","color"],"#000000"],"text-halo-color":"#FFFFFF","text-halo-width":2,"text-halo-blur":2}})}async function addGeoJsonLimitedSeaRouteLayer(){var e=await loadAndMergeData("./data/limitedSeaRoute.geojson","./data/limitedSeaRouteDetails.json","routeId");map.addSource("geojson_limited_sea_route",{type:"geojson",data:e}),map.addLayer({id:"geojson_limited_sea_route_outline",type:"line",source:"geojson_limited_sea_route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#000000","line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],3],.5],6,["+",["*",["coalesce",["get","freq"],3],1],4]],"line-opacity":.5}}),map.addLayer({id:"geojson_limited_sea_route_solidline",type:"line",source:"geojson_limited_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],null],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],1],.75],6,["*",["coalesce",["get","freq"],1],1]],"line-dasharray":[1,0]}}),map.addLayer({id:"geojson_limited_sea_route_dashline",type:"line",source:"geojson_limited_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],"season"],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],1],.75],6,["*",["coalesce",["get","freq"],1],1]],"line-dasharray":[1,2]}}),map.addLayer({id:"geojson_limited_sea_route_thinline",type:"line",source:"geojson_limited_sea_route",layout:{"line-join":"round","line-cap":"round"},filter:["==",["get","note"],"suspend"],paint:{"line-color":["coalesce",["get","color"],"#000000"],"line-width":["interpolate",["linear"],["zoom"],3,["*",["coalesce",["get","freq"],1],.75],6,["*",["coalesce",["get","freq"],1],1]],"line-dasharray":[1,4]}}),map.addLayer({id:"geojson_limited_sea_route_name",type:"symbol",source:"geojson_limited_sea_route",layout:{"symbol-placement":"line","text-offset":[0,1],"text-field":["step",["zoom"],"",4,["get","businessName"],6,["format",["get","businessName"],{}," (",{},["get","routeName"],{},") ",{}]],"text-font":["NotoSansCJKjp-Regular"],"text-size":9},paint:{"text-color":["coalesce",["get","color"],"#000000"],"text-halo-color":"#FFFFFF","text-halo-width":2,"text-halo-blur":2}})}function addSeaRouteClickEvent(e,o=e){map.on("click",o,o=>{const t=o.features[0].properties;let a=t.businessName,n="";if(a.includes("（")){const e=a.split("（");a=e[0],n=e[1].replace("）","")}const r=t.freqInfo?t.freqInfo.split(", ").map(e=>`<span class="block">${e.trim()}</span>`).join(""):"",i=t.info?t.info.split(", ").map(e=>`<span class="block">${e.trim()}</span>`).join(""):"",s=t.shipName?t.shipName.split(", ").map(e=>`<span class="block">・${e.trim()}</span>`).join(""):"",l=`\n            <div class="mb-3">\n                <div style="height:4px; width:100%; background:${t.color||"#e5e7eb"}; border-radius:6px;"></div>\n            </div>\n            <div class="mb-3 pb-2 border-b border-slate-200 flex items-center">\n                <h3 class="flex items-center justify-between text-xs font-semibold text-blue-600 w-24 min-w-[96px] text-center mr-2">\n                    <i class="fas fa-route fa-fw mr-1 text-blue-500"></i><span class="mx-auto">航路</span>\n                </h3>\n                <div class="text-gray-800 text-xs cursor-pointer hover:text-blue-600 underline hover:underline transition-colors" onclick="window.zoomToRoute({routeId: '${t.routeId||""}', sourceId: '${e}'})">${t.routeName||"N/A"}</div>\n            </div>\n            <div class="mb-3 pb-2 border-b border-slate-200 flex items-center">\n                <h3 class="flex items-center justify-between text-xs font-semibold text-green-600 w-24 min-w-[96px] text-center mr-2">\n                    <i class="fas fa-map-pin fa-fw mr-1 text-green-500"></i><span class="mx-auto">選択部分</span>\n                </h3>\n                <div class="text-gray-800 text-xs cursor-pointer hover:text-blue-600 underline hover:underline transition-colors" onclick="window.zoomToRouteSection('${t.routeId||""}', '${t.lineId||""}', '${e}')">${(t.portName1||"N/A").replace(/'/g,"&#39;").replace(/"/g,"&quot;")}～${(t.portName2||"N/A").replace(/'/g,"&#39;").replace(/"/g,"&quot;")}</div>\n            </div>\n            ${t.freqInfo?`\n                <div class="mb-3 pb-2 border-b border-slate-200 flex items-center">\n                    <h3 class="flex items-center justify-between text-xs font-semibold text-red-600 w-24 min-w-[96px] text-center mr-2">\n                        <i class="fas fa-rotate fa-fw mr-1 text-red-500"></i><span class="mx-auto">運行頻度</span>\n                    </h3>\n                    <div class="text-gray-800 text-xs">${r}</div>\n                </div>\n            `:""}\n            ${t.info?`\n                <div class="mb-3 pb-2 border-b border-slate-200 flex items-center">\n                    <h3 class="flex items-center justify-between text-xs font-semibold text-yellow-600 w-24 min-w-[96px] text-center mr-2">\n                        <i class="fas fa-info-circle fa-fw mr-1 text-yellow-500"></i><span class="mx-auto">情報</span>\n                    </h3>\n                    <div class="text-gray-800 text-xs">${i}</div>\n                </div>\n            `:""}\n            ${t.shipName?`\n                <div class="mb-3 pb-2 border-b border-slate-200 flex items-center">\n                    <h3 class="flex items-center justify-between text-xs font-semibold text-purple-600 w-24 min-w-[96px] text-center mr-2">\n                        <i class="fas fa-ship fa-fw mr-1 text-purple-500"></i><span class="mx-auto">船舶</span>\n                    </h3>\n                    <ul class="text-gray-800 text-xs">${s}</ul>\n                </div>\n            `:""}\n            ${t.url?(()=>{let e="";try{e=new URL(t.url).hostname}catch(o){e=t.url}return`\n                    <div class="mb-3 pb-2 border-b border-slate-200 flex items-center">\n                        <h3 class="flex items-center justify-between text-xs font-semibold text-indigo-600 w-24 min-w-[96px] text-center mr-2">\n                            <i class="fas fa-link fa-fw mr-1.5 text-indigo-500"></i><span class="mx-auto">リンク</span>\n                        </h3>\n                        <a href="${t.url}" target="_blank" rel="noopener noreferrer" class="text-gray-800 underline text-xs hover:text-blue-600 transition-all duration-200 rounded">運行スケジュール - ${e}</a>\n                    </div>\n                `})():""}\n            `;window.showDetailDrawerWithPinClear(l,a,n),gtag("event","marker_click",{event_category:"map",event_label:t.businessName,value:1})}),map.on("mousemove",o,()=>{map.getCanvas().style.cursor="pointer"}),map.on("mouseleave",o,()=>{map.getCanvas().style.cursor=""}),eventHandle[e]=o}function addPortClickEvent(e,o=e){map.on("click",o,e=>{const o=e.features[0].properties,t=o.Name||o.portName||"N/A",a=t.includes("港")||t.includes("桟橋")?t:`${t}港`,n=`https://www.google.com/maps/search/${encodeURIComponent(a)}`,r=o.info?o.info.split(", ").map(e=>`<span class="block">${e.trim()}</span>`).join(""):"",i=`\n            <div class="mb-3">\n                <div style="height:4px; width:100%; background:#505050; border-radius:6px;"></div>\n            </div>\n            <div class="mb-3 pb-2 border-b border-slate-200 flex items-center">\n                <h3 class="flex items-center justify-between text-xs font-semibold text-green-600 w-24 min-w-[96px] text-center mr-2">\n                    <i class="fas fa-map-marked-alt fa-fw mr-1 text-green-500"></i><span class="mx-auto">地図</span>\n                </h3>\n                <a href="${n}" target="_blank" rel="noopener noreferrer" class="text-gray-800 underline text-xs hover:text-blue-600 transition-all duration-200 rounded">Googleマップで開く</a>\n            </div>\n            ${o.info?`\n                <div class="mb-3 pb-2 border-b border-slate-200 flex items-center">\n                    <h3 class="flex items-center justify-between text-xs font-semibold text-yellow-600 w-24 min-w-[96px] text-center mr-2">\n                        <i class="fas fa-info-circle fa-fw mr-1 text-yellow-500"></i><span class="mx-auto">情報</span>\n                    </h3>\n                    <div class="text-gray-800 text-xs">${r}</div>\n                </div>\n            `:""}\n        `;window.showDetailDrawerWithPinClear(i,t,"港湾情報")}),map.on("mousemove",o,()=>{map.getCanvas().style.cursor="pointer"}),map.on("mouseleave",o,()=>{map.getCanvas().style.cursor=""}),eventHandle[e]=o}export function removeClickEvent(e){var o=eventHandle[e];o&&map.off("click",o)}export function addResetClickEvent(){map.on("click",e=>{const o=Object.values(eventHandle);map.queryRenderedFeatures(e.point).find(e=>o.includes(e.layer.id))||(window.hideSidebar&&window.hideSidebar(),removeRouteHighlight())})}function addRouteHighlight(e,o){removeRouteHighlight();const t={type:"FeatureCollection",features:e};map.addSource("route-highlight",{type:"geojson",data:t}),map.addLayer({id:"route-highlight-line",type:"line",source:"route-highlight",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":["coalesce",["get","color"],"#FF6B35"],"line-width":8,"line-opacity":.6}})}function removeRouteHighlight(){map.getLayer("route-highlight-line")&&map.removeLayer("route-highlight-line"),map.getSource("route-highlight")&&map.removeSource("route-highlight")}window.zoomToRoute=function(e){try{const{routeName:o,routeId:t,lineId:a,sourceId:n}=e,r=map.getSource(n);if(!r)return void console.error("Source not found:",n);const i=r._data;if(!i||!i.features)return void console.error("No features found in source:",n);let s=[],l="";if(o?(s=i.features.filter(e=>e.properties&&e.properties.routeName===o),l="routeName"):t&&a?(s=i.features.filter(e=>e.properties&&String(e.properties.routeId)===String(t)&&String(e.properties.lineId)===String(a)),l="routeSection",0===s.length&&(s=i.features.filter(e=>e.properties&&String(e.properties.routeId)===String(t)),l="routeOnly")):t&&(s=i.features.filter(e=>e.properties&&String(e.properties.routeId)===String(t)),l="routeOnly"),0===s.length)return void console.error("No matching features found for:",e);let d=1/0,c=1/0,u=-1/0,p=-1/0;if(s.forEach(e=>{"LineString"===e.geometry.type?e.geometry.coordinates.forEach(e=>{const[o,t]=e;d=Math.min(d,o),u=Math.max(u,o),c=Math.min(c,t),p=Math.max(p,t)}):"MultiLineString"===e.geometry.type&&e.geometry.coordinates.forEach(e=>{e.forEach(e=>{const[o,t]=e;d=Math.min(d,o),u=Math.max(u,o),c=Math.min(c,t),p=Math.max(p,t)})})}),d===1/0||c===1/0||u===-1/0||p===-1/0)return void console.error("Invalid bounds calculated for:",e);let m={top:50,left:50,right:50,bottom:50};const g=document.getElementById("detail-drawer");if(g&&!g.classList.contains("hidden"))if(window.innerWidth>=768){const e=g.offsetWidth;m.left=e+30}else{const e=g.offsetHeight;m.bottom=e+30}if(map.fitBounds([[d,c],[u,p]],{padding:m,duration:1e3}),addRouteHighlight(s,n),"undefined"!=typeof gtag){const e=o||`${t}-${a}`;gtag("event","routeName"===l?"route_zoom":"route_section_zoom",{event_category:"map",event_label:e,value:1})}}catch(e){console.error("Error in zoomToRoute:",e)}},window.removeRouteHighlight=removeRouteHighlight,window.zoomToRouteSection=function(e,o,t){window.zoomToRoute({routeId:e,lineId:o,sourceId:t})};export function toggleSuspendedRoutes(e){showSuspendedRoutes=e;["geojson_sea_route","geojson_international_sea_route","geojson_KR_sea_route","geojson_limited_sea_route"].forEach(o=>{["_outline","_solidline","_dashline","_thinline","_name"].forEach(t=>{const a=o+t;map.getLayer(a)&&(e?"_solidline"===t?map.setFilter(a,["==",["get","note"],null]):"_dashline"===t?map.setFilter(a,["==",["get","note"],"season"]):"_thinline"===t?map.setFilter(a,["==",["get","note"],"suspend"]):map.setFilter(a,null):"_solidline"===t?map.setFilter(a,["==",["get","note"],null]):"_dashline"===t?map.setFilter(a,["==",["get","note"],"season"]):"_thinline"===t?map.setFilter(a,["==",["get","note"],"never_match"]):map.setFilter(a,["!=",["get","note"],"suspend"]))})})}