import layersControl from"./layersControl.js";import hamburgerControl from"./hamburgerControl.js";import{addRasterLayer}from"./rasterLayers.js";import{addGeoJsonLayer,addMarker,addResetClickEvent,toggleSuspendedRoutes}from"./geoJsonLayers.js";import{showDetailDrawer}from"./detailDrawer.js";import{initCenterZoom,setCookie,getCookie}from"./cookieControl.js";import{showContextMenu,hideContextMenu}from"./contextMenu.js";import{createLayersConfig}from"./layerConfig.js";export var map=null;export const mapStyle={EMPTY_MAP:0,OSM_BRIGHT_MAP:10,OSM_PLANET_MAP:11,OTM_MAP:12,OPEN_SEA_MAP:13,RAILWAY_MAP:14,GSI_STD_MAP:20,GSI_PALE_MAP:21,GSI_BLANK_MAP:22,GSI_PHOTO_MAP:23,GSI_RELIEF_MAP:24,TRANSPORT_MAP:30,ESRI_PHOTO_MAP:40,OSM_CUSTOM_MAP:90};export const layerPriorities=["tile_gsi_photo","tile_gsi_relief","tile_esriimagery","tile_railwaymap","tile_openseamap","geojson_sea_route","geojson_international_sea_route","geojson_limited_sea_route","geojson_port"];var currentMap=null,currentLayer=[],defaultMap=mapStyle.EMPTY_MAP,defaultLayer=["geojson_sea_route"];let touchTimeout;getCookie("currentMap")&&(defaultMap=parseInt(getCookie("currentMap"))),getCookie("currentLayer")&&(defaultLayer=getCookie("currentLayer").split(","));let isDragging=!1;function initMap(){const[e,t]=initCenterZoom();(map=new maplibregl.Map({container:"map",style:getMapStyle(currentMap),center:e,zoom:t,pitch:0})).addControl(new maplibregl.NavigationControl,"bottom-right"),map.addControl(new maplibregl.GeolocateControl,"bottom-right"),map.addControl(new maplibregl.ScaleControl,"bottom-left"),map.addControl(new hamburgerControl,"top-right"),map.addControl(addGeocoderControl(),"top-left"),addMoveEndEvent(),addContextEvent(),addResetClickEvent(),map.on("load",()=>{const e=document.getElementById("detail-drawer");e&&(e.style.display="")})}function getMapStyle(e){switch(e){case mapStyle.OSM_PLANET_MAP:return"https://tile.openstreetmap.jp/styles/openmaptiles/style.json";case mapStyle.OSM_BRIGHT_MAP:return"https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json";case mapStyle.GSI_STD_MAP:return"https://gsi-cyberjapan.github.io/gsivectortile-mapbox-gl-js/std.json";case mapStyle.GSI_PALE_MAP:return"https://gsi-cyberjapan.github.io/gsivectortile-mapbox-gl-js/pale.json";case mapStyle.GSI_BLANK_MAP:return"https://gsi-cyberjapan.github.io/gsivectortile-mapbox-gl-js/blank.json";case mapStyle.OSM_CUSTOM_MAP:return"./style/osm-bright-style.json";default:return"./style/empty.json"}}initMap(),map.once("styledata",()=>{const e=createLayersConfig(mapStyle,defaultLayer,isIdInLayer);let t=new layersControl({layers:e,defaultBaseLayer:defaultMap});map.addControl(t,"top-right")});export function updateBaseMap(e){if(currentMap!=e){switch(currentMap){case mapStyle.OTM_MAP:removeLayerSource("tile_otm","tile_otm");break;case mapStyle.TRANSPORT_MAP:removeLayerSource("tile_transportmap","tile_transportmap");break;case mapStyle.ESRI_PHOTO_MAP:removeLayerSource("tile_esriimagery","tile_esriimagery")}changeStyle(getMapStyle(e)),currentMap=e,map.once("styledata",()=>{switch(e){case mapStyle.OTM_MAP:addRasterLayer(mapStyle.OTM_MAP),updateLayerOrder();break;case mapStyle.TRANSPORT_MAP:addRasterLayer(mapStyle.TRANSPORT_MAP),updateLayerOrder();break;case mapStyle.ESRI_PHOTO_MAP:addRasterLayer(mapStyle.ESRI_PHOTO_MAP),updateLayerOrder()}}),setCookie("currentMap",currentMap,30)}}async function changeStyle(e){map.setStyle(e,{transformStyle:(e,t)=>{var r=e.layers.filter(e=>e.id.startsWith("geojson")||e.id.startsWith("tile")),a=t.layers.concat(r),o=t.sources;for(const[t,r]of Object.entries(e.sources))(t.startsWith("geojson")||t.startsWith("tile"))&&(o[t]=r);return{...t,sources:o,layers:a}},diff:!currentMap}),reAddMaker()}function reAddMaker(){currentLayer.includes("geojson_port")&&addMarker("anchor_marker","./img/anchor.png")}function updateLayerOrder(e=0,t=30,r=1e3){if(!(e>=t)){for(const a of layerPriorities)if(currentLayer.includes(a)){const o=a;if(!map.getSource(o)||!map.isSourceLoaded(o))return void setTimeout(()=>{updateLayerOrder(e+1,t)},r)}layerPriorities.forEach(e=>{currentLayer.includes(e)&&map.getStyle().layers.forEach(t=>{t.id.startsWith(e)&&map.moveLayer(t.id)})})}}function removeLayerSource(e,t=e){removeLayer(e),removeSource(t)}function removeLayer(e){map.getStyle().layers.forEach(t=>{t.id.startsWith(e)&&map.removeLayer(t.id)}),currentLayer=currentLayer.filter(t=>t!==e)}function removeSource(e){map.getSource(e)&&map.removeSource(e)}export async function addOverLayer(e){if(currentLayer.includes(e))console.log("[Warning] Layer already exists : addOverLayer( "+e+" )");else{if(e.startsWith("tile"))switch(e){case"tile_gsi_photo":addRasterLayer(mapStyle.GSI_PHOTO_MAP);break;case"tile_gsi_relief":addRasterLayer(mapStyle.GSI_RELIEF_MAP);break;case"tile_esriimagery":addRasterLayer(mapStyle.ESRI_PHOTO_MAP);break;case"tile_openseamap":addRasterLayer(mapStyle.OPEN_SEA_MAP);break;case"tile_railwaymap":addRasterLayer(mapStyle.RAILWAY_MAP);break;default:return void console.log("[Error] Layer not found : addOverLayer( "+e+" )")}else{if(!e.startsWith("geojson"))return void console.log("[Error] Layer not found : addOverLayer( "+e+" )");addGeoJsonLayer(e)}map.once("idle",()=>{currentLayer.push(e),updateLayerOrder(),setCookie("currentLayer",currentLayer,30)})}}export async function removeOverLayer(e,t=e){currentLayer.includes(e)?(removeLayerSource(e,t),setCookie("currentLayer",currentLayer,30)):console.log("[Warning] Layer already not exists : removeOverLayer( "+e+" )")}function isIdInLayer(e,t){return e&&e.includes(t)}function addGeocoderControl(){const e=new MaplibreGeocoder({forwardGeocode:async e=>{const t=[];try{const r=`https://nominatim.openstreetmap.org/search?q=${e.query}&format=geojson&polygon_geojson=1&addressdetails=1`,a=await fetch(r),o=await a.json();for(const e of o.features){const r=[e.bbox[0]+(e.bbox[2]-e.bbox[0])/2,e.bbox[1]+(e.bbox[3]-e.bbox[1])/2],a={type:"Feature",geometry:{type:"Point",coordinates:r},place_name:e.properties.display_name,properties:e.properties,text:e.properties.display_name,place_type:["place"],center:r};t.push(a)}}catch(e){console.log(`[Error] Failed to forwardGeocode with error: ${e}`)}return{features:t}}},{maplibregl:maplibregl,marker:{color:"red"},placeholder:"Search",collapsed:!0,limit:10,showResultsWhileTyping:!0,OptionalminLength:3,zoom:12});return e.onAdd=function(e){const t=MaplibreGeocoder.prototype.onAdd.call(this,e);return t.classList.add("maplibregl-ctrl-group"),t},e}function addMoveEndEvent(){map.on("moveend",()=>{const e=map.getCenter(),t=map.getZoom();setCookie("mapCenter",JSON.stringify([e.lng,e.lat]),30),setCookie("mapZoom",t,30)})}function addContextEvent(){const e=document.getElementById("map");let t=null,r=!1,a=null;function o(){a&&(a.remove(),a=null)}window.showDetailDrawerWithPinClear=function(e,t,r){o(),showDetailDrawer(e,t,r)},window.removeLongPressMarker=o,e.addEventListener("contextmenu",e=>{window.matchMedia("(pointer: coarse)").matches||(e.preventDefault(),showContextMenu(e.clientX,e.clientY,map))}),e.addEventListener("touchstart",e=>{window.matchMedia("(pointer: coarse)").matches&&1===e.touches.length&&(r=!1,t=setTimeout(()=>{if(!r){const t=e.touches[0];if(window.map&&"function"==typeof map.unproject){const e=map.unproject([t.clientX,t.clientY]),r=e.lat.toFixed(5),n=e.lng.toFixed(5);o(),a=new maplibregl.Marker({color:"red"}).setLngLat([parseFloat(n),parseFloat(r)]).addTo(map);showDetailDrawer(`\n                        <div class="mb-3">\n                            <div style="height:4px; width:100%; background:#60a5fa; border-radius:6px;"></div>\n                        </div>\n                        <div class="mb-3 pb-2 border-b border-slate-200 flex items-center">\n                            <h3 class="flex items-center justify-between text-xs font-semibold text-blue-600 w-24 min-w-[96px] text-center mr-2">\n                                <i class="fas fa-location-dot fa-fw mr-1 text-blue-500"></i><span class="mx-auto">住所</span>\n                            </h3>\n                            <span id="reverse-geocode-address" class="block text-xs text-gray-800 mt-1">取得中...</span></div>\n                        </div>\n                        <div class="mb-3 pb-2 border-b border-slate-200 flex items-center">\n                            <h3 class="flex items-center justify-between text-xs font-semibold text-green-600 w-24 min-w-[96px] text-center mr-2">\n                                <i class="fas fa-map-location-dot fa-fw mr-1 text-green-500"></i><span class="mx-auto">リンク</span>\n                            </h3>\n                            <a href="https://maps.google.com/?q=${r},${n}" target="_blank" rel="noopener noreferrer" class="text-gray-800 underline text-xs hover:text-gray-900 transition-all">ここをGoogleマップで開く</a>\n                        </div>\n                    `,`${r}, ${n}`,"座標情報"),fetch(`https://nominatim.openstreetmap.org/reverse?lat=${r}&lon=${n}&format=json&accept-language=ja`).then(e=>e.json()).then(e=>{let t=e.display_name||"住所情報なし";t&&"住所情報なし"!==t&&(t=t.split(",").map(e=>e.trim()).reverse().join(" "));const r=document.getElementById("reverse-geocode-address");r&&(r.textContent=t)}).catch(()=>{const e=document.getElementById("reverse-geocode-address");e&&(e.textContent="住所取得失敗")})}}},700))}),e.addEventListener("touchmove",()=>{r=!0,clearTimeout(t)}),e.addEventListener("touchend",()=>{clearTimeout(t)}),document.getElementById("detail-drawer-close-btn").addEventListener("click",o)}function initSettings(){const e=document.getElementById("suspend-route-toggle");if(!e)return void console.warn("suspend-route-toggle element not found");const t="false"!==getCookie("showSuspendedRoutes");e.checked=t,toggleSuspendedRoutes(t),e.addEventListener("change",e=>{const t=e.target.checked;toggleSuspendedRoutes(t),setCookie("showSuspendedRoutes",t.toString(),365)})}document.addEventListener("DOMContentLoaded",()=>{if(map&&map.loaded())initSettings();else{const e=()=>{map&&map.loaded()?initSettings():setTimeout(e,100)};e()}});